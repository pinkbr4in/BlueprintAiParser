# render.yaml (Using Environment Group)

# Define Databases FIRST
databases:
  - name: blueprint-redis # Name used in fromService below
    plan: free
    databaseName: blueprint_parser_redis
    ipAllowList: []

# Define Environment Groups SECOND
envGroups:
  - name: shared-config # Name your group
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: blueprint-redis # Reference the database defined above
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: blueprint-redis
          property: connectionString # Append /1 in code or UI if needed later
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: blueprint-redis
          property: connectionString # Append /2 in code or UI if needed later
      # You could also move R2 config here if desired, but let's keep it simple for now

# Define Services LAST
services:
  # Web Service (Flask/Gunicorn)
  - type: web
    name: blueprint-parser-web
    env: python
    plan: free
    envGroup: shared-config # <-- Link to the Environment Group
    buildCommand: "pip install -r requirements.txt"
    startCommand: "gunicorn wsgi:application"
    envVars:
      # Inherits Redis URLs from shared-config group
      - key: PYTHON_VERSION
        value: "3.12"
      - key: FLASK_APP
        value: "wsgi:application"
      - key: FLASK_ENV
        value: "production"
      - key: SECRET_KEY
        generateValue: true
      # --- R2/S3 Config (Set via UI) ---
      - key: R2_ENDPOINT_URL
        value: "https://0948134cfe20aade9cfc72f11f995766.r2.cloudflarestorage.com"
      - key: R2_BUCKET_NAME
        value: "blueprint-parser-uploads"
      # R2 Keys are set manually in Render UI Environment Variables

  # Worker Service (Celery)
  - type: worker
    name: blueprint-parser-worker
    env: python
    plan: free
    envGroup: shared-config # <-- Link to the Environment Group
    buildCommand: "pip install -r requirements.txt"
    startCommand: "celery -A celery_app.celery worker --loglevel=info -c 1"
    envVars:
      # Inherits Redis URLs from shared-config group
      - key: PYTHON_VERSION
        value: "3.12"
      - key: FLASK_ENV
        value: "production"
      # --- R2/S3 Config (Set via UI) ---
      - key: R2_ENDPOINT_URL
        value: "https://0948134cfe20aade9cfc72f11f995766.r2.cloudflarestorage.com"
      - key: R2_BUCKET_NAME
        value: "blueprint-parser-uploads"
      # R2 Keys are set manually in Render UI Environment Variables