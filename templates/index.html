<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unreal Engine Blueprint Parser</title>
    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <!-- Custom CSS - Load before highlight.js -->
    <link rel="stylesheet" href="{{ url_for('static', filename='blueprint-parser.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='blueprint-highlight.css') }}">
    <!-- Highlight.js Dark Theme - Load AFTER custom CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1>Unreal Engine Blueprint Parser</h1>
        <p>Paste the raw text copied from the Blueprint editor below and click "Parse Blueprint".</p>

        <!-- Form Section -->
        <form method="post" class="mb-4">
            <div class="form-group">
                <label for="blueprintText">Paste Blueprint Text:</label>
                <textarea id="blueprintText" name="blueprint_text" rows="15" class="form-control code-input" placeholder="Begin Object Class=... End Object">{{ raw_blueprint_text }}</textarea>
            </div>
            <button type="submit" class="btn btn-success btn-lg">Parse Blueprint</button>
        </form>

        {% if error_message %}
            <div class="alert alert-danger" role="alert">
                <strong>Error:</strong> {{ error_message }}
            </div>
        {% endif %}

        <!-- Output Section -->
        {% if blueprint_output or ai_output %}
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="outputTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="human-tab" data-toggle="tab" href="#human" role="tab" aria-controls="human" aria-selected="true">Human-Readable</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="ai-tab" data-toggle="tab" href="#ai" role="tab" aria-controls="ai" aria-selected="false">AI-Readable (JSON)</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="outputTabContent">
                                <!-- Human Readable Tab -->
                                <div class="tab-pane fade show active" id="human" role="tabpanel" aria-labelledby="human-tab">
                                     {% if stats_summary %}
                                          <div class="stats-summary mb-3">
                                              {{ stats_summary | markdown | safe }}
                                          </div>
                                      {% endif %}
                                    {% if blueprint_output %}
                                      <div class="markdown-body">
                                        {{ blueprint_output | markdown | safe }}
                                      </div>
                                    {% elif request.method == 'POST' and not error_message %}
                                      <p class="text-muted">No human-readable output generated.</p>
                                    {% endif %}
                                </div>
                                <!-- AI Readable Tab -->
                                <div class="tab-pane fade" id="ai" role="tabpanel" aria-labelledby="ai-tab">
                                    {% if ai_output %}
                                      <!-- Add copy button -->
                                      <button id="copy-btn" class="btn btn-secondary btn-sm mb-2 float-right">Copy JSON</button>
                                      <div style="clear:both;"></div> <!-- Clear float -->
                                      <!-- Use 'language-json' class for highlight.js -->
                                      <pre><code class="language-json">{{ ai_output }}</code></pre>
                                    {% elif request.method == 'POST' and not error_message %}
                                       <p class="text-muted">No AI-readable output generated.</p>
                                    {% else %}
                                      <p class="text-muted">AI-readable JSON output will appear here after parsing.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% elif request.method == 'POST' and not error_message %}
             <p class="text-muted">No output generated. Please check the input text.</p>
        {% else %}
             <p class="text-muted">Results will appear here after parsing.</p>
        {% endif %}
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    
    <!-- Configure highlight.js BEFORE loading it -->
    <script>
      // Set up our configuration before loading highlight.js
      window.hljs_ignore_blueprint = true;
    </script>
    
    <!-- Load highlight.js after configuring it -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    
    <!-- Configure highlight.js to ignore blueprint code blocks -->
    <script>
      // Configure highlight.js to ignore blueprint code blocks 
      document.addEventListener('DOMContentLoaded', function() {
        // Store original highlightAll function
        const originalHighlightAll = hljs.highlightAll;
        
        // Override highlightAll to skip blueprint blocks
        hljs.highlightAll = function(options) {
          // First, mark all blueprint blocks to be skipped
          document.querySelectorAll('pre.blueprint code').forEach(block => {
            block.setAttribute('data-nohighlight', 'true');
            
            // If already highlighted by highlight.js, restore original content
            if(block.classList.contains('hljs')) {
              // Check if we have the original content stored
              const originalContent = block.getAttribute('data-original-content');
              if(originalContent) {
                block.innerHTML = originalContent;
              }
              // Remove highlight.js classes
              block.classList.remove('hljs', 'language-markdown', 'language-javascript');
              block.removeAttribute('data-highlighted');
            }
          });
          
          // Call the original function
          originalHighlightAll(options);
          
          // After highlighting, apply our own styles to blueprint blocks
          fixBlueprintStyling();
        };
        
        function fixBlueprintStyling() {
          document.querySelectorAll('pre.blueprint code').forEach(block => {
            // Force all spans to have correct styling
            block.querySelectorAll('span[class^="bp-"]').forEach(span => {
              span.style.display = 'inline';
              
              // Apply colors based on class
              if (span.classList.contains('bp-keyword')) {
                span.style.color = '#c792ea';
                span.style.fontWeight = 'bold';
              } else if (span.classList.contains('bp-event-name')) {
                span.style.color = '#ffcb6b';
                span.style.fontWeight = 'bold';
              } else if (span.classList.contains('bp-var')) {
                span.style.color = '#79d0ff';
              } else if (span.classList.contains('bp-func-name')) {
                span.style.color = '#c792ea';
                span.style.fontWeight = 'bold';
              }
              // Add more class-specific inline styles as needed
            });
          });
        }
      });
    </script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>

    <script>
        // Initialize highlight.js for JSON
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();
            
            // Copy JSON to clipboard
            const copyBtn = document.getElementById('copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const aiCodeElement = document.querySelector('#ai pre code');
                    if (aiCodeElement) {
                        const textToCopy = aiCodeElement.textContent;
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = 'Copied!';
                            copyBtn.disabled = true;
                            setTimeout(() => {
                                copyBtn.textContent = originalText;
                                copyBtn.disabled = false;
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy: ', err);
                            alert('Failed to copy. Try manually selecting the text.');
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>